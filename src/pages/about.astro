---
import BaseLayout from '@layouts/BaseLayout.astro';

const writings = [
  {
    href: 'https://product.kyobobook.co.kr/detail/S000213641007',
    text: '코딩 테스트 합격자 되기: 자바스크립트 편'
  },
  {
    href: 'https://product.kyobobook.co.kr/detail/S000212233308',
    text: '리액트 훅을 활용한 마이크로 상태 관리'
  },
  {
    href: 'http://www.yes24.com/24/goods/56894866',
    text: 'Vue.js 이 정도는 알아야지'
  }
];

interface PinnedRepo {
  name: string;
  description: string;
  url: string;
  stars: number;
  language: string;
  languageColor: string;
}

let pinnedRepos: PinnedRepo[] = [];

const token = import.meta.env.GITHUB_TOKEN;
if (token) {
  try {
    const res = await fetch('https://api.github.com/graphql', {
      method: 'POST',
      headers: {
        Authorization: `bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        query: `{
          user(login: "kciter") {
            pinnedItems(first: 6, types: REPOSITORY) {
              nodes {
                ... on Repository {
                  name description url stargazerCount
                  primaryLanguage { name color }
                }
              }
            }
          }
        }`,
      }),
    });
    const json = await res.json();
    const nodes = json?.data?.user?.pinnedItems?.nodes ?? [];
    pinnedRepos = nodes.map((n: any) => ({
      name: n.name,
      description: n.description || '',
      url: n.url,
      stars: n.stargazerCount,
      language: n.primaryLanguage?.name || '',
      languageColor: n.primaryLanguage?.color || '#999',
    }));
  } catch (e) {
    console.warn('Failed to fetch pinned repos from GitHub API');
  }
}
---

<BaseLayout title="About">
  <section class="about-section">
    <h2 class="section-title">My Keyboard</h2>
    <div class="keyboard-img">
      <img src="/images/about/keyboard.jpg" />
    </div>
  </section>

  <section class="about-section">
    <h2 class="section-title">Writing</h2>
    <ul class="writing-list">
      {writings.map(item => (
        <li>
          <a href={item.href} target="_blank" rel="noopener noreferrer">{item.text}</a>
        </li>
      ))}
    </ul>
  </section>

  <section class="about-section">
    <h2 class="section-title">Open Source</h2>
    {pinnedRepos.length > 0 ? (
      <div class="repo-grid">
        {pinnedRepos.map(repo => (
          <a href={repo.url} target="_blank" rel="noopener noreferrer" class="repo-card">
            <div class="repo-name">{repo.name}</div>
            <div class="repo-desc">{repo.description}</div>
            <div class="repo-meta">
              {repo.language && (
                <span class="repo-lang">
                  <span class="lang-dot" style={`background: ${repo.languageColor};`} />
                  {repo.language}
                </span>
              )}
              <span class="repo-stars">
                <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                  <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z" />
                </svg>
                {repo.stars.toLocaleString()}
              </span>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <div class="paper">
        <a href="https://github.com/kciter" target="_blank" rel="noopener noreferrer" class="entry">
          GitHub Profile
        </a>
      </div>
    )}
  </section>
</BaseLayout>

<style>
  .about-section {
    margin-bottom: 36px;
  }

  .section-title {
    font-size: 1.3em;
    font-weight: 700;
    color: #454f5b;
    margin-bottom: 16px;
    padding-bottom: 0;
    border-bottom: none;
    margin-top: 0;
  }

  .keyboard-img img {
    max-width: 400px;
    width: 100%;
    border-radius: 12px;
    border: 1px solid #eee;
  }

  .writing-list {
    padding-left: 20px;
    margin: 0;
  }

  .writing-list li {
    padding: 2px 0;
    font-size: 15px;
  }

  .writing-list a {
    color: #454f5b;
    text-decoration: none;
    transition: color 0.15s;
  }

  .writing-list a:hover {
    color: #00a962;
  }

  /* Repo grid */
  .repo-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .repo-card {
    display: flex;
    flex-direction: column;
    padding: 16px;
    border: 1px solid #eee;
    border-radius: 12px;
    text-decoration: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .repo-card:hover {
    border-color: #ccc;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .repo-name {
    font-size: 15px;
    font-weight: 700;
    color: #212b36;
    margin-bottom: 6px;
  }

  .repo-card:hover .repo-name {
    color: #00a962;
  }

  .repo-desc {
    font-size: 13px;
    color: #666;
    line-height: 1.4;
    flex: 1;
    margin-bottom: 12px;
  }

  .repo-meta {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 12px;
    color: #999;
  }

  .repo-lang {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .lang-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .repo-stars {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .repo-stars svg {
    color: #e3b341;
  }

  @media (max-width: 640px) {
    .repo-grid {
      grid-template-columns: 1fr;
    }

    .keyboard-img img {
      max-width: 100%;
    }
  }
</style>
