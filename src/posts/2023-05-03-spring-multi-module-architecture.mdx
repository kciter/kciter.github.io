---
title: "IoC와 DI를 이용한 Spring 멀티 모듈 아키텍처"
categories: dev
tags: [Spring, 아키텍처, 모듈]
image: /images/2023-05-03-spring-multi-module-architecture/thumbnail.png
comments: true
draft: false
---

import Image from '@components/Image';

아키텍처란 개발자들에게 영원히 흥미로운 주제다. 훌륭한 아키텍처는 개발자와 소프트웨어 품질에 많은 도움을 준다. 많은 개발자가 아키텍처란 그저 `개발자가 일을 하는 방법`이라고 말한다. 필자 또한 이 말에 동의한다. 다시 한 번 일을 하는 방법이란 말에 대해 생각해보자. 일은 그냥 하면 되는데 왜 방법을 만드는 걸까?

여러가지 답이 있을 수 있겠지만 필자가 생각하는 가장 큰 이유는 **목표를 효과적으로 이루기 위해서**라고 생각한다. 그래서 우리가 무언가 일을 할 때는 목표를 정하고 그에 맞춰 일하는 방법을 정한다. 소프트웨어도 마찬가지다. 회사의 규모, 고객의 요구사항, 환경 등에 따라 목표가 달라지고 그에 맞춰 아키텍처는 달라진다. 즉, 우리는 해야하는 **업무에 적합한 아키텍처**를 선택할 수 있고 그에 따라 **생산성**이 달라질 수 있다.

일을 하는 방법에는 효율을 위한 규칙과 제약이 포함되어 있다. 따라서, 아키텍처를 풀어서 말해보자면 `효율적인 코드 작성을 위한 규칙과 제약`이라고 할 수 있다. 이 규칙과 제약은 어떤 제품을 만드냐에 따라 크게 달라질 수 있다.

이 글에서는 **확장성과 모듈 독립화**를 목표로 하는 아키텍처를 설명하고자 한다. 아키텍처를 설명하기 위해 Spring Boot를 기반으로 하고 Gradle을 이용하여 멀티 모듈을 구성한다.

# 도메인과 모듈
우리가 만드는 소프트웨어는 비즈니스와 밀접한 연관이 있다. 이때 도메인은 **비즈니스에서 소프트웨어로 문제를 해결하기 위한 영역**을 말한다. 개발자는 도메인과 유스케이스를 논리적인 코드로 작성하고 사용자에게 제품으로 제공한다. 도메인을 이해하고 이에 따라 코드를 작성하는 것이 중요하기 때문에 [도메인 주도 설계(Domain-Driven Design)](https://ko.wikipedia.org/wiki/%EB%8F%84%EB%A9%94%EC%9D%B8_%EC%A3%BC%EB%8F%84_%EC%84%A4%EA%B3%84) 방법론을 이용하는 팀이 많다. 필자가 재직하고 있는 회사 또한 도메인에 기반하여 제품에 대해 논의하고 개발한다.

따라서 개발팀은 도메인의 역할과 제약을 기반으로 논리를 만들어내기 때문에 도메인은 아키텍처를 구성하는데 중요한 역할을 한다. 개발팀이 협업을 잘하기 위해선 도메인 영역을 나누고 도메인 모델이 서로 어떤 관계를 가지고 있는지 파악하는 것이 중요하다. 그래서 보통 도메인 영역을 별도의 모듈로 분리하여 관리하는 경우가 많다. 흔히 모듈을 평가할 때 `결합도와 응집도`를 보게되는데 결합도는 모듈 사이에서 서로 의존하는 정도를 말하고 응집도는 모듈 내에 기능이 서로 연관이 있는지를 말한다. 보통 결합도는 낮을 수록 좋고 응집도는 높을 수록 좋다.

<Image src="/images/2023-05-03-spring-multi-module-architecture/coupling-cohesion.png" caption="소프트웨어 공학을 공부하면 자주 보는 그림" />

## 인터페이스

추가로 모듈에서 중요한 것은 `인터페이스`다. 해당 모듈이 무엇을 제공하는지를 인터페이스로 정의하고 외부에 노출한다. 이렇게 하면 외부에서 해당 모듈을 사용할 때 인터페이스를 통해 사용할 수 있기 때문에 모듈 내부의 구현이 변경되어도 외부에 영향을 주지 않는다. 이를 통해 모듈의 독립성을 높일 수 있다. 또한, 개발자는 인터페이스를 보고 어떤 기능이 제공되고 필요한지 알 수 있기 때문에 협업에도 도움이 된다.

<Image src="/images/2023-05-03-spring-multi-module-architecture/module-interface.png" caption="인터페이스는 어떤 기능을 제공하는지 나타내는 문서라고도 볼 수 있다" />

이 글에서 다루는 Spring에선 개발자가 다른 모듈의 기능이 필요한 경우 해당 인터페이스를 주입하여 사용할 수 있다. 이를 **인터페이스 주입(Interface Injection)**이라고 하는데 뒤에서 설명할 Spring의 의존성 주입(Dependency Injection)을 통해 가능하다. 따라서 개발자는 인터페이스의 구현체를 몰라도 해당 기능을 사용할 수 있다. 이를 통해 모듈 간의 결합도를 낮출 수 있다.

## 순환 종속성 문제
이상적으로 도메인에 따라 모듈을 나누기만 하면 깔끔한 아키텍처를 설계할 수 있을 것 같지만 실제 상황에선 항상 문제가 생기기 마련이다. 예를 들어, A 모듈이 B 모듈을 의존하고 B 모듈이 A 모듈을 의존하는 경우가 있다. 이런 경우를 **순환 의존 관계(Circular Dependency)**라고 한다. 이런 경우 Message Queue 등을 사용해 비동기 통신을 하는 것이 아니라면 어쩔 수 없이 모듈을 합치거나 별도 다른 모듈로 기능을 분리하는 경우가 많다.

왜 이런 일이 발생하는지 알기 위해 한 가지 예시를 들어보자. 만약 우리가 게시판 서비스를 만들어야 한다고 가정해보자.
* 게시물 작성
* 게시물 리스트 조회
* 게시물 상세 조회
  * 작성된 댓글도 포함됨
* 댓글 작성
* ...

게시판 서비스를 만든다면 대략 위와 같은 기능들이 필요할 것이다. 이런 상황에서 Article 모듈과 Comment 모듈을 나누는 것은 좋은 방법이다. Article과 Comment의 책임을 분리하고 각 도메인에 따라 로직을 구현할 수 있으며 모듈 간의 의존 관계도 명확하다. 의존 관계의 예를 들면 게시물 상세 조회 기능을 구현하기 위해선 Article 모듈에서 Comment 모듈에 포함된 기능을 사용할 수 있다.

그런데 만약 '내가 작성한 댓글 조회'라는 기능이 추가되고 어떤 게시물에 댓글을 남겼는지 정보가 필요하다고 가정해보자. 그러면 Article에 대한 정보가 필요하기 때문에 Comment 모듈에서 Article 모듈을 의존해야한다. 이런 경우 **순환 의존 관계**가 발생한다. 의존 관계에 Cycle이 발생하면 빌드가 되지 않는다.

<Image src="/images/2023-05-03-spring-multi-module-architecture/circular-dependency.png" caption="순환 의존 관계" />

이런 경우 어떻게 해야할까? 앞서 말한 것 처럼 순환 의존 관계를 해결하기 위해 Article 모듈과 Comment 모듈을 하나로 합치거나 Article 모듈과 Comment 모듈을 둘 다 의존하는 별도의 모듈을 만드는 방법을 이용할 수도 있다. 하지만, 이런 경우 특정 기능만을 위한 모듈이나 도메인 정책에 맞지 않는 모듈이 생겨날 가능성이 높다. 모듈이 목적성을 잃게되면 의사소통에 혼란이 생기고 관련된 모듈의 응집도가 낮아진다. 이를 해결하기 위한 방법 중 하나로 **IoC와 DI**를 이용할 수 있다.

# IoC와 DI를 이용한 아키텍처
IoC와 DI를 이용한 아키텍처 패턴은 이미 리팩토링이라는 책으로 유명한 마틴 파울러가 [Inversion of Control Container and the Dependency Injection pattern](https://www.martinfowler.com/articles/injection.html)라는 아티클로 잘 정리한 자료가 있다. 해당 아키텍처에 대해 설명하기 전에 먼저 DI와 IoC에 대해 알아보자.

## 의존성 주입(DI)이란?
DI는 Dependency Injection의 약자로 의존성 주입이라고 한다. 의존성 주입은 이름 그대로 의존성을 주입하는 것이다. 의존성이란 어떤 객체가 다른 객체를 사용하는 것을 의미한다. 예를 들어, 위에서 예시로 든 것처럼 Article 모듈에서 Comment 모듈을 사용한다고 가정해보자. 이런 경우 Article 모듈은 Comment 모듈을 사용하기 위해 Comment 모듈의 인스턴스를 생성하고 사용해야한다. 이때 Article 모듈은 Comment 모듈의 인스턴스를 직접 생성하는 것이 아니라 외부에서 생성한 인스턴스를 주입받아 사용할 수 있다. 이렇게 외부에서 생성한 인스턴스를 주입받는 것을 **의존성 주입(Dependency Injection)**이라고 한다.

## 제어의 역전(IoC)이란?
IoC는 Inversion of Control의 약자로 제어의 역전이라고 한다. 제어의 역전이란 기존에는 개발자가 프로그램의 흐름을 제어했다면 IoC는 프레임워크가 프로그램의 흐름을 제어한다.

## 인터페이스 주입

# Spring 멀티 모듈 아키텍처

## 컨셉 아키텍처

## 구현 아키텍처

## Gradle 멀티 모듈

## 사용 예제

# 마치며
필자가 재직 중인 회사 [코발트](https://www.cobalt.run/)에서는 백엔드 도메인과 로직을 이 글에서 설명한 DI와 IoC를 이용하여 관리하고 있다. 모듈이 제공한 인터페이스를 통해서만 통신이 가능하고 모듈간 의존을 엄격히 관리하기 때문에 불편한 점도 있지만 **모듈의 목적성을 잃지 않고 응집도가 높은 모듈**을 만들 수 있다는 장점이 있다. 또 다른 장점으로는 **모듈 단위로 분리**가 쉽기 때문에 새로운 서버 애플리케이션을 쉽게 만들 수 있다는 점이다. 만약 MSA로 백엔드를 운영하고 있다면 이 아키텍처를 적용해보는 것도 좋을 것 같다.

현재 잘 관리하고 있지는 않지만 해당 아키텍처의 형태로 프로젝트를 생성할 수 있는 [오픈 소스](https://github.com/cobaltinc/bloom)를 만들어두었다. 만약 이 아키텍처에 관심이 있다면 해당 프로젝트를 참고하면 좋을 것 같다.