---
import BaseLayout from '@layouts/BaseLayout.astro';
import { getPublishedPosts, getSlugFromId, getDateFromId, getReadingTime, getExcerpt } from '@utils/posts';
import dayjs from 'dayjs';
import localizedFormat from 'dayjs/plugin/localizedFormat.js';

dayjs.extend(localizedFormat);

const posts = await getPublishedPosts();
---

<BaseLayout title="Timeline">
  {
    posts.map(post => {
      const slug = getSlugFromId(post.id);
      const date = getDateFromId(post.id);
      const readingTime = getReadingTime(post.body || '');
      const excerpt = getExcerpt(post.body || '');
      const isRecent = dayjs(date).isAfter(dayjs().subtract(1, 'month'));

      return (
        <div class="mx-auto flex h-auto list-none p-0 leading-[26px]">
          {/* Desktop date column */}
          <div class="w-[15%] pr-6 text-right max-md:hidden" style="box-sizing: content-box;">
            <div class="-translate-y-2.5">
              <div class="text-base font-bold text-[#444]">
                {dayjs(date).locale('en').format('ll')}
              </div>
              <div class="text-[10px] leading-relaxed text-[#aaa]">
                {Math.round(readingTime.minutes)} minute read
              </div>
            </div>
          </div>

          {/* Content column */}
          <div
            class:list={[
              'timeline-content relative min-w-0 flex-1 border-l border-[#ddd] pb-[60px] pl-6',
              { recent: isRecent }
            ]}
          >
            <a href={`/posts/${slug}/`} style="text-decoration: none;">
              <div class="content-inner -mt-2 transition-all duration-[333ms] ease-[ease] max-md:-mt-3">
                {/* Mobile date */}
                <div class="mb-1 hidden text-sm font-bold text-[#444] max-md:block">
                  {dayjs(date).locale('en').format('ll')}
                </div>

                {/* Tags */}
                <div class="relative mb-2 flex w-full flex-nowrap gap-1 overflow-hidden whitespace-nowrap">
                  <div class="inline-flex items-center justify-center rounded-[50px] border border-[#888] bg-white px-2 text-[9px] text-[#888]" style="height: 16px;">
                    {post.data.categories}
                  </div>
                  {post.data.tags?.map((tag: string) => (
                    <div class="inline-flex items-center justify-center rounded-[50px] border border-[#dfe3e8] bg-white px-2 text-[9px] text-[#888]" style="height: 16px;">
                      {tag}
                    </div>
                  ))}
                  <div class="pointer-events-none absolute top-0 right-0 h-full w-20 bg-gradient-to-r from-transparent to-white" />
                </div>

                <h1 style="font-size: 20px; margin: 0 0 8px 0; padding: 0; border: none; color: #454f5b;">
                  {post.data.title}
                </h1>

                {excerpt && (
                  <p class="text-sm leading-[1.4] text-[#212b36]" style="margin: 0 0 8px 0;">{excerpt}</p>
                )}

                {post.data.image && (
                  <img
                    src={post.data.image}
                    alt={post.data.title}
                    loading="lazy"
                    class="block rounded-lg shadow-[0_1px_2px_rgba(0,0,0,0.1)]"
                  />
                )}
              </div>
            </a>
          </div>
        </div>
      );
    })
  }
</BaseLayout>

<style>
  .timeline-content::after {
    box-sizing: content-box;
    content: '';
    display: block;
    height: 10px;
    width: 10px;
    left: -6px;
    position: absolute;
    top: -4px;
    border-radius: 12px;
    border: 1px solid #eee;
    background: #888;
  }

  .timeline-content.recent::after {
    background: #00a962;
    box-shadow: rgb(51, 217, 178) 0px 0px 0px 0px;
    animation: 2s ease 0s infinite normal none running pulse-dot;
  }

  .content-inner {
    position: relative;
    transform: scale3d(1, 1, 1);
  }

  .content-inner::after {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 8px;
    transform: scale(1.04);
    transition: opacity 2s cubic-bezier(0.165, 0.84, 0.44, 1);
    box-shadow:
      0 8px 17px 0 rgba(0, 0, 0, 0.2),
      0 6px 20px 0 rgba(0, 0, 0, 0.15);
    content: '';
    opacity: 0;
    z-index: -1;
  }

  .content-inner:hover {
    transform: scale3d(1.006, 1.006, 1);
  }

  .content-inner:hover::after {
    opacity: 1;
  }
</style>
