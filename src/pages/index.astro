---
import BaseLayout from '@layouts/BaseLayout.astro';
import { getPublishedPosts, getSlugFromId, getDateFromId, getReadingTime, getExcerpt } from '@utils/posts';
import dayjs from 'dayjs';
import localizedFormat from 'dayjs/plugin/localizedFormat.js';

dayjs.extend(localizedFormat);

const allPosts = await getPublishedPosts();
const articles = allPosts.filter(p => p.data.categories === 'article');

const thoughts = allPosts.filter(p => p.data.categories === 'thought');
const books = allPosts.filter(p => p.data.categories === 'book-report');

const [featured, ...remaining] = articles;
const featuredSlug = getSlugFromId(featured.id);
const featuredDate = getDateFromId(featured.id);
const featuredReadingTime = getReadingTime(featured.body || '');
const featuredExcerpt = getExcerpt(featured.body || '', 200);

const sidePosts = remaining.slice(0, 2).map(post => ({
  post,
  slug: getSlugFromId(post.id),
  date: getDateFromId(post.id),
}));

const bottomPosts = remaining.slice(2, 5).map(post => ({
  post,
  slug: getSlugFromId(post.id),
  date: getDateFromId(post.id),
}));

const recentThoughts = thoughts.slice(0, 5).map(post => ({
  title: post.data.title,
  slug: getSlugFromId(post.id),
  date: getDateFromId(post.id),
}));

const recentBooks = books.slice(0, 8).map(post => ({
  title: post.data.title,
  slug: getSlugFromId(post.id),
  cover: post.data.cover,
}));
---

<BaseLayout>
  {/* Profile */}
  <div class="profile">
    <div class="profile-avatar">
      <img
        src="/images/about/avatar.jpg"
        alt="Sunhyoup Lee"
        class="profile-img"
      />
    </div>
    <div class="profile-name">Sunhyoup Lee</div>
    <div class="profile-subtitle">Just a Developer</div>
  </div>

  {/* Bento Grid */}
  <div class="bento">
    {/* Featured - large left */}
    <a href={`/posts/${featuredSlug}/`} class="bento-featured">
      {featured.data.image && (
        <img
          src={featured.data.image}
          alt={featured.data.title}
          class="bento-featured-image"
        />
      )}
      <div class="bento-featured-body">
        <div class="bento-tag">Latest</div>
        <h2 class="bento-featured-title">{featured.data.title}</h2>
        {featuredExcerpt && (
          <p class="bento-featured-excerpt">{featuredExcerpt}</p>
        )}
        <div class="bento-meta">
          {dayjs(featuredDate).locale('en').format('ll')} &middot; {Math.round(featuredReadingTime.minutes)} min read
        </div>
      </div>
    </a>

    {/* Side - stacked right */}
    <div class="bento-side">
      {sidePosts.map(({ post, slug, date }) => (
        <a href={`/posts/${slug}/`} class="bento-side-card">
          {post.data.image && (
            <img
              src={post.data.image}
              alt={post.data.title}
              loading="lazy"
              class="bento-side-image"
            />
          )}
          <div class="bento-side-body">
            <div class="bento-side-title">{post.data.title}</div>
            <div class="bento-meta">{dayjs(date).locale('en').format('ll')}</div>
          </div>
        </a>
      ))}
    </div>
  </div>

  {/* Bottom row */}
  <div class="bento-bottom-row">
    <div class="section-row">
      <div class="section-label">MORE ARTICLES</div>
      <a href="/articles/" class="section-link">All articles &#x25B8;</a>
    </div>
    <div class="bento-bottom">
      {bottomPosts.map(({ post, slug, date }) => (
        <a href={`/posts/${slug}/`} class="bento-bottom-card">
          {post.data.image && (
            <img
              src={post.data.image}
              alt={post.data.title}
              loading="lazy"
              class="bento-bottom-image"
            />
          )}
          <div class="bento-bottom-title">{post.data.title}</div>
          <div class="bento-meta">{dayjs(date).locale('en').format('ll')}</div>
        </a>
      ))}
    </div>
  </div>

  {/* Thought & Bookshelf */}
  <div class="extra-sections">
    {/* Thought */}
    <div class="extra-section">
      <div class="section-row">
        <div class="section-label">THOUGHTS</div>
        <a href="/thought/" class="section-link">All thoughts &#x25B8;</a>
      </div>
      <div class="thought-list">
        {recentThoughts.map(({ title, slug, date }) => (
          <a href={`/posts/${slug}/`} class="thought-item">
            <span class="thought-date">{dayjs(date).format('YY.MM.DD')}</span>
            <span class="thought-title">{title}</span>
          </a>
        ))}
      </div>
    </div>

    {/* Bookshelf */}
    <div class="extra-section">
      <div class="section-row">
        <div class="section-label">BOOKSHELF</div>
        <a href="/bookshelf/" class="section-link">All books &#x25B8;</a>
      </div>
      <div class="book-grid">
        {recentBooks.map(({ title, slug, cover }) => (
          <a href={`/posts/${slug}/`} class="book-card">
            {cover && (
              <img src={cover} alt={title} loading="lazy" class="book-cover" />
            )}
          </a>
        ))}
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Profile */
  .profile {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-bottom: 32px;
    text-align: center;
  }

  .profile-avatar {
    width: 96px;
    height: 96px;
    border-radius: 50%;
    box-shadow: 1px 2px 6px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .profile-img {
    width: 92px;
    height: 92px;
    border-radius: 50%;
    object-fit: cover;
  }

  .profile-name {
    font-size: 1.5rem;
    font-weight: bold;
    color: #212b36;
  }

  .profile-subtitle {
    font-size: 0.85rem;
    color: #888;
    margin-top: -4px;
  }

  /* Bento grid - top section */
  .bento {
    display: grid;
    grid-template-columns: 3fr 2fr;
    gap: 16px;
    margin-bottom: 32px;
  }

  /* Featured card */
  .bento-featured {
    display: flex;
    flex-direction: column;
    text-decoration: none;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
    border: 1px solid #eee;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .bento-featured:hover {
    border-color: #ccc;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  }

  .bento-featured-image {
    width: 100%;
    aspect-ratio: 16/10;
    object-fit: cover;
  }

  .bento-featured-body {
    padding: 16px 18px 18px;
    flex: 1;
  }

  .bento-tag {
    display: inline-block;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: #00a962;
    background: rgba(0, 169, 98, 0.08);
    padding: 3px 8px;
    border-radius: 4px;
    margin-bottom: 10px;
  }

  .bento-featured-title {
    border: none;
    padding: 0;
    margin: 0 0 8px 0;
    font-size: 1.2rem;
    font-weight: 700;
    color: #212b36;
    line-height: 1.35;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .bento-featured:hover .bento-featured-title {
    color: #00a962;
    transition: color 0.2s;
  }

  .bento-featured-excerpt {
    font-size: 0.85rem;
    color: #666;
    line-height: 1.5;
    margin: 0 0 10px 0;
    display: -webkit-box;
    -webkit-line-clamp: 5;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .bento-meta {
    font-size: 0.75rem;
    color: #aaa;
  }

  /* Side cards - stacked */
  .bento-side {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .bento-side-card {
    flex: 1;
    display: flex;
    flex-direction: column;
    text-decoration: none;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
    border: 1px solid #eee;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .bento-side-card:hover {
    border-color: #ccc;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  }

  .bento-side-image {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
  }

  .bento-side-body {
    padding: 12px 14px 14px;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .bento-side-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #212b36;
    line-height: 1.35;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .bento-side-card:hover .bento-side-title {
    color: #00a962;
    transition: color 0.2s;
  }

  /* Bottom row */
  .bento-bottom-row {
    margin-bottom: 16px;
  }

  .section-row {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .section-label {
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 2px;
    color: #999;
  }

  .section-link {
    font-size: 13px;
    font-weight: 500;
    text-decoration: none;
    color: #aaa;
    cursor: pointer;
  }

  .section-link:hover {
    color: #00a962;
  }

  .bento-bottom {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
  }

  .bento-bottom-card {
    text-decoration: none;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
    border: 1px solid #eee;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .bento-bottom-card:hover {
    border-color: #ccc;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  }

  .bento-bottom-image {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
  }

  .bento-bottom-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #212b36;
    line-height: 1.35;
    padding: 10px 12px 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .bento-bottom-card:hover .bento-bottom-title {
    color: #00a962;
    transition: color 0.2s;
  }

  .bento-bottom-card .bento-meta {
    padding: 6px 12px 12px;
  }

  /* Extra sections (Thought + Bookshelf) */
  .extra-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
    margin-top: 32px;
    margin-bottom: 16px;
  }

  .extra-section .section-row {
    margin-bottom: 12px;
  }

  /* Thought list */
  .thought-list {
    display: flex;
    flex-direction: column;
  }

  .thought-item {
    display: flex;
    align-items: baseline;
    gap: 10px;
    padding: 8px 0;
    text-decoration: none;
    border-bottom: 1px solid #f0f0f0;
  }

  .thought-item:first-child {
    padding-top: 0;
  }

  .thought-date {
    font-size: 0.75rem;
    color: #bbb;
    font-family: 'Courier New', monospace;
    flex-shrink: 0;
  }

  .thought-title {
    font-size: 0.85rem;
    color: #454f5b;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .thought-item:hover .thought-title {
    color: #00a962;
    transition: color 0.2s;
  }

  /* Book grid */
  .book-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }

  .book-card {
    text-decoration: none;
    display: block;
    transition: transform 0.2s;
  }

  .book-card:hover {
    transform: translateY(-4px);
  }

  .book-cover {
    width: 100%;
    aspect-ratio: 3/4;
    object-fit: cover;
    border-radius: 4px;
    box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.15);
  }

  /* Mobile */
  @media (max-width: 768px) {
    .bento {
      grid-template-columns: 1fr;
    }

    .bento-side {
      flex-direction: row;
    }

    .bento-side-card {
      flex: 1;
    }

    .bento-bottom {
      grid-template-columns: 1fr;
    }

    .bento-bottom-card {
      display: grid;
      grid-template-columns: 100px 1fr;
      grid-template-rows: auto auto;
    }

    .bento-bottom-image {
      grid-row: 1 / 3;
      height: 100%;
      aspect-ratio: auto;
    }

    .bento-bottom-title {
      padding: 10px 12px 0;
      align-self: end;
    }

    .bento-bottom-card .bento-meta {
      padding: 4px 12px 10px;
    }
  }

  @media (max-width: 30rem) {
    .bento-side {
      flex-direction: column;
    }

    .extra-sections {
      grid-template-columns: 1fr;
      gap: 28px;
    }

    .book-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }
</style>
